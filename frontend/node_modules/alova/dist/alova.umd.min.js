!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).alova={})}(this,(function(t){"use strict";const e="undefined",a=Object,o=void 0,s=null,n=!1,r=t=>typeof t;typeof window===e&&typeof process!==e&&process.cwd;const c="memory",i=()=>{},l=t=>t,h=t=>"function"===r(t),u=t=>a.prototype.toString.call(t),d=t=>"[object Object]"===u(t),p=(t,e)=>t instanceof e,f=t=>t?t.getTime():Date.now(),y=t=>t.context,m=t=>t.config,g=t=>t.options,w=t=>{const{params:e,headers:a}=m(t);return o=[t.type,t.url,e,t.data,a],JSON.stringify(o,s,n);var o,s,n},C=t=>t.key,v=t=>{const{cacheFor:e}=m(t),a=t=>{return"number"!==r(e=t)||Number.isNaN(e)?f(t||o):f()+t;var e};let s=c,i=()=>0,l=n,u=o;const p=h(e);if(!p){let n=e;if(d(e)){const{mode:t=c,expire:a,tag:r}=e||{};s=t,l="restore"===t,u=r?r.toString():o,n=a}i=e=>a(h(n)?n({method:t,mode:e}):n)}return{f:e,c:p,e:i,m:s,s:l,t:u}},b=(t,...e)=>new t(...e),S=(t,e)=>"$a."+t+e,$="undefined",k=Promise,x=Object,E=RegExp,O=void 0,T=!0,D=!1,H=(t,e,a)=>t.then(e,a),j=(t,e)=>t.finally(e),M=t=>x.keys(t),R=(t,e)=>t.forEach(e),U=(t,...e)=>t.push(...e),P=(t,e)=>t.map(e),A=(t,e)=>t.filter(e),N=t=>t.length,q=t=>Array.isArray(t),F=(t,e)=>delete t[e],L=typeof window===$&&(typeof process!==$?"function"==typeof process.cwd:typeof Deno!==$),B="memory",I="restore";t.globalConfigMap={autoHitCache:"global",ssr:L};const _="color: black; font-size: 12px; font-weight: bolder";var G=(e,a,o,s)=>{const n=console,r=(...t)=>console.log(...t),{url:c}=a,i=o===I,l="[42m%s[49m",h="[32m%s[39m",u=` [HitCache]${c} `,d=()=>Array(N(u)+1).join("^");t.globalConfigMap.ssr?(r(l,u),r(h," Cache ",e),r(h," Mode  ",o),i&&r(h," Tag   ",s),r(h,d())):(n.groupCollapsed?n.groupCollapsed("%cHitCache","padding: 2px 6px; background: #c4fcd3; color: #53b56d;",c):r(l,u),r("%c[Cache]",_,e),r("%c[Mode]",_,o),i&&r("%c[Tag]",_,s),r("%c[Method]",_,a),n.groupEnd?n.groupEnd():r(h,d()))};const J=t=>`hss.${t}`,K="hsr.",z=t=>K+t,W="$$hsrs",Q="__$<>$__",V=(t,e)=>{t[e]=0},X=async(t,e,a,o,s,n,r)=>{if(o>f()&&a){const c=S(t,e);if(await s.set(c,A([a,o===1/0?O:o,r],Boolean)),n){const t={},e=[];R(n,(a=>{const o=p(a,E),s=o?a.source+(a.flags?Q+a.flags:""):a;s&&(o&&!t[s]&&U(e,s),V(t,o?z(s):J(s)))}));const a=P(M(t),(async t=>{const e=await s.get(t)||{};V(e,c),await s.set(t,e)})),o=async()=>{if(N(e)){const t=await s.get(W)||[];U(t,...e),await s.set(W,t)}};await k.all([...a,o()])}}},Y=async(t,e,a)=>{const o=S(t,e);await a.remove(o)},Z=async(t,e,a,o)=>{const s=await a.get(S(t,e));if(s){const[n,r,c]=s;if(c===o&&(!r||r>f()))return s;await Y(t,e,a)}},tt=async(t,e,a,o)=>{const s=await Z(t,e,a,o);return s?s[0]:O},et=async t=>k.all(t.map((t=>t.clear())));var at=t=>{const{data:e,config:o}=t,s={...o},{headers:n={},params:r={}}=s,c=y(t);s.headers={...n},s.params={...r};return((t,...e)=>a.assign(t,...e))(b(it,t.type,c,t.url,s,e),{...t,config:s})};const ot=async e=>{const{autoHitCache:a}=t.globalConfigMap,{l1Cache:o,l2Cache:s}=y(e),n=C(e),{name:r}=m(e),c={global:[...kt,...xt],self:[o,s],close:[]}[a];c&&N(c)&&await k.all(P(c,(t=>(async(t,e,a)=>{const o=`${e}`,s={},n=J(t);let r;if(s[n]=await a.get(n),e){const t=J(o);s[t]=await a.get(t),r=await a.get(W);const e=[];r&&N(r)&&(R(r,(t=>{const[a,s]=t.split(Q);b(E,a,s).test(o)&&U(e,t)})),await k.all(P(e,(async t=>{const e=z(t);s[e]=await a.get(e)}))))}const c=async t=>{try{await a.remove(t);for(const e in s){const a=s[e];a&&F(a,t)}}catch(t){}},i={};await k.all(P(M(s),(async t=>{const e=s[t];if(e){const t=[];for(const a in e)i[a]||(V(i,a),U(t,c(a)));await k.all(t)}})));const l=N(r||[]);await k.all(P(M(s),(async t=>{const e=s[t];e&&(N(M(e))?await a.set(t,e):(await a.remove(t),t.includes(K)&&r&&(r=A(r,(e=>z(e)!==t)))))}))),l!==N(r||[])&&await a.set(W,r)})(n,r,t))))},st={},nt=(t,e,a)=>{t=t.endsWith("/")?t.slice(0,-1):t,""!==e&&(e=e.match(/^(\/|https?:\/\/)/)?e:`/${e}`);const o=t+e,s=P(A(M(a),(t=>a[t]!==O)),(t=>`${t}=${a[t]}`)).join("&");return s?+o.includes("?")?`${o}&${s}`:`${o}?${s}`:o};function rt(t,e){let a,o=T;const r=b(k,(t=>{a=t}));return{abort:()=>{H(r,(t=>t&&t.abort()))},onDownload:t=>{H(r,(e=>e&&e.onDownload&&e.onDownload(t)))},onUpload:t=>{H(r,(e=>e&&e.onUpload&&e.onUpload(t)))},response:async()=>{const{beforeRequest:r=i,responded:c,requestAdapter:f,cacheLogger:w}=(t=>g(y(t)))(t),b=C(t),{s:S,t:$,m:x,e:E}=v(t),{id:T,l1Cache:M,l2Cache:R,snapshots:U}=y(t),{cacheFor:P}=m(t),{hitSource:A}=t;let N=await(h(P)?P():e?O:tt(T,b,M));if(x===I&&!N){const t=await Z(T,b,R,$);if(t){const[e,a]=t;await X(T,b,e,a,M,A),N=e}}const q=at(t);await r(q);const{baseURL:L,url:_,type:J,data:K}=q,{params:z={},headers:W={},transform:Q=l,shareRequest:V}=m(q),Y=st[T]=st[T]||{};let et=Y[b],rt=l,ct=O,it=i;if(h(c))rt=c;else if(d(c)){const{onSuccess:t,onError:e,onComplete:a}=c;rt=h(t)?t:rt,ct=h(e)?e:ct,it=h(a)?a:it}if(N!==O)return a(),(ht=G,h(lt=w)?lt:[n,s].includes(lt)?i:ht)(N,q,x,$),it(q),N;var lt,ht;if(o=D,!V||!et){const t=f({url:nt(L,_,z),type:J,data:K,headers:W},q);et=Y[b]=t}a(et);const ut=async(e,a,o=true)=>{const s=await e,n=await Q(s,a||{});U.save(t);try{await ot(q)}catch(t){}const r=q.data,c=!r||!(t=>{const e=u(t);return/^\[object (Blob|FormData|ReadableStream|URLSearchParams)\]$/i.test(e)||p(t,ArrayBuffer)})(r);if(c&&o)try{await k.all([X(T,b,n,E(B),M,A),S&&X(T,b,n,E(I),R,A,$)])}catch(t){}return n};return j(H(k.all([et.response(),et.headers()]),(([t,e])=>(F(Y,b),ut(rt(t,q),e))),(t=>{return F(Y,b),h(ct)?ut(ct(t,q),O,D):(e=t,k.reject(e));var e})),(()=>{it(q)}))},fromCache:()=>o}}const ct=(t,e)=>()=>{const a=e.indexOf(t);a>=0&&e.splice(a,1)};class it{constructor(t,e,a,o,s){this.dhs=[],this.uhs=[],this.fromCache=O;const n=()=>{n.a()};n.a=i;const r=this,c=g(e);r.abort=n,r.baseURL=c.baseURL||"",r.url=a,r.type=t,r.context=e;const l={},h="cacheFor",u=d(c[h])?c[h][t]:O,f=o&&o.hitSource;R(["timeout","shareRequest"],(t=>{c[t]!==O&&(l[t]=c[t])})),u!==O&&(l[h]=u),f&&(r.hitSource=P(q(f)?f:[f],(t=>p(t,it)?C(t):t)),F(o,"hitSource")),r.config={...l,headers:{},params:{},...o||{}},r.data=s,r.meta=o?o.meta:r.meta,r.key=r.generateKey()}onDownload(t){return U(this.dhs,t),ct(t,this.dhs)}onUpload(t){return U(this.uhs,t),ct(t,this.uhs)}send(t=false){const e=this,{response:a,onDownload:o,onUpload:s,abort:n,fromCache:r}=rt(e,t);return N(e.dhs)>0&&o(((t,a)=>R(e.dhs,(e=>e({loaded:t,total:a}))))),N(e.uhs)>0&&s(((t,a)=>R(e.uhs,(e=>e({loaded:t,total:a}))))),e.abort.a=n,e.fromCache=O,e.promise=H(a(),(t=>(e.fromCache=r(),t))),e.promise}setName(t){m(this).name=t}generateKey(){return w(this)}then(t,e){return H(this.send(),t,e)}catch(t){return((t,e)=>t.catch(e))(this.send(),t)}finally(t){return j(this.send(),t)}}const lt="undefined";typeof window===lt&&typeof process!==lt&&process.cwd;class ht extends Error{constructor(t,e,a){super(e+(a?`\n\nFor detailed: https://alova.js.org/error#${a}`:"")),this.name=`[alova${t?`/${t}`:""}]`}}const ut=((t="")=>(e,a,o)=>{if(!e)throw((t,...e)=>new t(...e))(ht,t,a,o)})(),dt="undefined";typeof window===dt&&typeof process!==dt&&process.cwd;const pt=()=>{const t={};return{eventMap:t,on(e,a){const o=t[e]=t[e]||[];return((t,...e)=>{t.push(...e)})(o,a),()=>{var s;t[e]=(s=t=>t!==a,o.filter(s))}},off(e,a){const o=t[e];if(o)if(a){const t=o.indexOf(a);t>-1&&o.splice(t,1)}else delete t[e]},emit(e,a){const o=t[e]||[];return s=t=>t(a),o.map(s);var s}}},ft="success",yt=()=>(ut("undefined"!=typeof localStorage,"l2Cache is not defined."),localStorage),mt=()=>{const t=pt(),e={set:(e,a)=>{yt().setItem(e,((t,e,a)=>JSON.stringify(t,e,a))(a)),t.emit(ft,{type:"set",key:e,value:a,container:yt()})},get:e=>{const a=yt().getItem(e),o=a?(t=>JSON.parse(t))(a):a;return t.emit(ft,{type:"get",key:e,value:o,container:yt()}),o},remove:e=>{yt().removeItem(e),t.emit(ft,{type:"remove",key:e,container:yt()})},clear:()=>{yt().clear(),t.emit(ft,{type:"clear",key:"",container:yt()})},emitter:t};return e},gt=Set;class wt{constructor(t){this.records={},this.occupy=0,ut(t>=0,"expected snapshots limit to be >= 0"),this.capacity=t}save(t){const{name:e}=m(t),{records:a,occupy:o,capacity:s}=this;if(e&&o<s){(a[e]=a[e]||b(gt)).add(t),this.occupy+=1}}match(t,e=!0){let a,o,s,n=t;d(t)&&(n=t.name,s=t.filter),p(n,E)?o=n:"string"===r(n)&&(a=n);const{records:c}=this;let i=b(gt);a?i=c[a]||i:o&&R(A(M(c),(t=>o.test(t))),(t=>{c[t].forEach((t=>i.add(t)))}));const l=h(s)?A([...i],s):[...i];return e?l:l[0]}}const Ct="GET",vt={cacheFor:{[Ct]:3e5},shareRequest:T,snapshots:1e3};let bt=0;class St{constructor(t){var e,a;const o=this;o.id=(t.id||(bt+=1)).toString(),o.l1Cache=t.l1Cache||(()=>{let t={};const e=pt(),a={set(a,o){t[a]=o,e.emit(ft,{type:"set",key:a,value:o,container:t})},get:a=>{const o=t[a];return e.emit(ft,{type:"get",key:a,value:o,container:t}),o},remove(a){F(t,a),e.emit(ft,{type:"remove",key:a,container:t})},clear:()=>{t={},e.emit(ft,{type:"clear",key:"",container:t})},emitter:e};return a})(),o.l2Cache=t.l2Cache||mt(),o.options={...vt,...t},o.snapshots=b(wt,null!==(a=null!==(e=t.snapshots)&&void 0!==e?e:vt.snapshots)&&void 0!==a?a:0)}Get(t,e){return b(it,"GET",this,t,e)}Post(t,e,a){return b(it,"POST",this,t,a,e)}Delete(t,e,a){return b(it,"DELETE",this,t,a,e)}Put(t,e,a){return b(it,"PUT",this,t,a,e)}Head(t,e){return b(it,"HEAD",this,t,e)}Patch(t,e,a){return b(it,"PATCH",this,t,a,e)}Options(t,e){return b(it,"OPTIONS",this,t,e)}}let $t=O;const kt=[],xt=[];t.Method=it,t.createAlova=t=>{const e=b(St,t),a=e.options.statesHook;$t&&ut($t===a,"expected to use the same `statesHook`"),$t=a;const{l1Cache:o,l2Cache:s}=e;return!kt.includes(o)&&U(kt,o),!xt.includes(s)&&U(xt,s),e},t.globalConfig=e=>{t.globalConfigMap={...t.globalConfigMap,...e}},t.hitCacheBySource=ot,t.invalidateCache=async t=>{if(!t)return void await k.all([et(kt),et(xt)]);const e=(q(t)?t:[t]).map((t=>{const{id:e,l1Cache:a,l2Cache:o}=y(t),{c:s}=v(t);if(s)return;const n=C(t);return k.all([Y(e,n,a),Y(e,n,o)])}));await k.all(e)},t.promiseStatesHook=()=>(ut(!!$t,"`statesHook` is not set in alova instance"),$t),t.queryCache=async(t,{policy:e="all"}={})=>{if(t&&t.key){const{id:a,l1Cache:o,l2Cache:s}=y(t),n=C(t),{f:r,c:c,s:i,e:l,t:h}=v(t);if(c)return r();let u="l2"!==e?await tt(a,n,o):O;return"l2"===e?u=await tt(a,n,s,h):"all"!==e||u||i&&l(I)>f()&&(u=await tt(a,n,s,h)),u}},t.setCache=async(t,e,{policy:a="all"}={})=>{const o=(q(t)?t:[t]).map((async t=>{const{hitSource:o}=t,{id:s,l1Cache:n,l2Cache:r}=y(t),c=C(t),{e:i,s:l,t:u,c:d}=v(t);if(d)return;let p=e;if(h(e)){let t="l2"!==a?await tt(s,c,n):O;if(("l2"===a||"all"===a&&!t&&l&&i(I)>f())&&(t=await tt(s,c,r,u)),p=e(t),p===O)return}return k.all(["l2"!==a&&X(s,c,p,i(B),n,o),"l2"===a||"all"===a&&l?X(s,c,p,i(I),r,o,u):O])}));return k.all(o)}}));
